 import yfinance as yf

import pandas as pd

import requests

import json

import matplotlib.pyplot as plt

from datetime import datetime, timedelta

import sys

import os



# Ottiene il percorso della cartella padre e lo aggiunge al percorso dei moduli di Python

# Questo risolve il "ModuleNotFoundError"

# rimosso perchÃ© non Ã¨ necessario per questa struttura di cartelle

# current_dir = os.path.dirname(os.path.abspath(__file__))

# parent_dir = os.path.dirname(current_dir)

# if parent_dir not in sys.path:

# Â  Â  sys.path.append(parent_dir)



# Importa i moduli di supporto

from data_sources.data_retriever import get_all_data

from data_sources.macro_data_retriever import get_cpi_data

from data_visualizer.plotter import plot_price_performance, plot_quarterly_financials



# ==============================================================================

# DATI UTENTE E PORTAFOGLIO

# ==============================================================================



PORTFOLIO = {

Â  Â  'ENI.MI': {'shares': 100, 'buy_price': 13.00},

Â  Â  'ISP.MI': {'shares': 200, 'buy_price': 2.50},

Â  Â  'AAPL': {'shares': 10, 'buy_price': 170.00},

}



# ==============================================================================

# AGENTE PRINCIPALE (Basato sui tuoi 25 Blocchi)

# ==============================================================================



class ChiefInvestmentStrategist:

Â  Â  """

Â  Â  Questo agente esegue una strategia di investimento basata su 25 compiti.

Â  Â  Ogni metodo rappresenta un blocco logico della strategia.

Â  Â  """



Â  Â  def __init__(self, portfolio):

Â  Â  Â  Â  self.portfolio = portfolio

Â  Â  Â  Â  self.data = {}

Â  Â  Â  Â 

Â  Â  def execute_strategy(self):

Â  Â  Â  Â  """

Â  Â  Â  Â  Orchestra l'esecuzione di tutti i 25 blocchi della strategia.

Â  Â  Â  Â  """

Â  Â  Â  Â  print("ğŸš€ L'Agente Chief Investment Strategist sta avviando l'analisi...")



Â  Â  Â  Â  # BLOCCO 1: Recupero dati del portafoglio (prezzi e info)

Â  Â  Â  Â  self.step_1_retrieve_data()



Â  Â  Â  Â  # BLOCCO 2: Calcolo del valore totale del portafoglio

Â  Â  Â  Â  self.step_2_calculate_total_value()



Â  Â  Â  Â  # BLOCCO 3: Analisi P/L (Profitto/Perdita)

Â  Â  Â  Â  self.step_3_analyze_pl()



Â  Â  Â  Â  # BLOCCO 4: Generazione grafici di performance YTD (Year-To-Date)

Â  Â  Â  Â  self.step_4_generate_ytd_charts()



Â  Â  Â  Â  # BLOCCO 5: Analisi macroeconomica (corretta con FRED API)

Â  Â  Â  Â  self.step_5_macro_analysis()



Â  Â  Â  Â  # BLOCCO 6: Selezione di nuovi titoli (Screener)

Â  Â  Â  Â  self.step_6_stock_screener()

Â  Â  Â  Â 

Â  Â  Â  Â  # BLOCCO 7: Generazione del report finale

Â  Â  Â  Â  self.step_7_generate_final_report()



Â  Â  Â  Â  # BLOCCO 8: Controllo del portafoglio esistente (Peer analysis)

Â  Â  Â  Â  self.step_8_portfolio_check()

Â  Â  Â  Â 

Â  Â  Â  Â  # NUOVO BLOCCO 9: Esportazione dati su file JSON

Â  Â  Â  Â  self.step_9_export_to_json()



Â  Â  Â  Â  # ... (BLOCCHI 10-25: Verranno aggiunti qui man mano)

Â  Â  Â  Â  # Ogni metodo rappresenta un passo specifico della tua strategia.

Â  Â  Â  Â  print("âœ… Analisi completa. Il tuo report Ã¨ pronto e salvato in un file JSON.")



Â  Â  def step_1_retrieve_data(self):

Â  Â  Â  Â  """BLOCCO 1: Recupera i dati di tutti i titoli del portafoglio."""

Â  Â  Â  Â  print("Fase 1: Recupero dei dati...")

Â  Â  Â  Â 

Â  Â  Â  Â  for ticker, info in self.portfolio.items():

Â  Â  Â  Â  Â  Â  data_retrieved = get_all_data(ticker)

Â  Â  Â  Â  Â  Â  if data_retrieved and data_retrieved['price']:

Â  Â  Â  Â  Â  Â  Â  Â  self.data[ticker] = {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'price': data_retrieved['price'],

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'history': data_retrieved.get('history'),

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'revenues': data_retrieved.get('revenues'),

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'earnings': data_retrieved.get('earnings'),

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  print(f"âœ… Dati recuperati per {ticker}.")

Â  Â  Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  Â  Â  print(f"âŒ Impossibile recuperare dati per {ticker}. Saltando.")



Â  Â  def step_2_calculate_total_value(self):

Â  Â  Â  Â  """BLOCCO 2: Calcola il valore totale del portafoglio."""

Â  Â  Â  Â  print("Fase 2: Calcolo del valore totale...")

Â  Â  Â  Â  total_value = 0

Â  Â  Â  Â  for ticker, info in self.portfolio.items():

Â  Â  Â  Â  Â  Â  if ticker in self.data and 'price' in self.data[ticker]:

Â  Â  Â  Â  Â  Â  Â  Â  total_value += self.data[ticker]['price'] * info['shares']

Â  Â  Â  Â 

Â  Â  Â  Â  self.data['total_value'] = total_value

Â  Â  Â  Â  print(f"âœ… Valore totale del portafoglio calcolato: {total_value:,.2f}")



Â  Â  def step_3_analyze_pl(self):

Â  Â  Â  Â  """BLOCCO 3: Analizza il profitto e la perdita di ogni titolo."""

Â  Â  Â  Â  print("Fase 3: Analisi del P/L...")

Â  Â  Â  Â  total_pl = 0

Â  Â  Â  Â  results = []

Â  Â  Â  Â  for ticker, info in self.portfolio.items():

Â  Â  Â  Â  Â  Â  if ticker in self.data and 'price' in self.data[ticker]:

Â  Â  Â  Â  Â  Â  Â  Â  current_price = self.data[ticker]['price']

Â  Â  Â  Â  Â  Â  Â  Â  shares = info['shares']

Â  Â  Â  Â  Â  Â  Â  Â  buy_price = info['buy_price']

Â  Â  Â  Â  Â  Â  Â  Â  pl = (current_price - buy_price) * shares

Â  Â  Â  Â  Â  Â  Â  Â  total_pl += pl

Â  Â  Â  Â  Â  Â  Â  Â 

Â  Â  Â  Â  Â  Â  Â  Â  results.append({

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Simbolo': ticker,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Prezzo': current_price,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Valore': round(current_price * shares, 2),

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'P/L': round(pl, 2),

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Rendimento': round((pl / (buy_price * shares)) * 100, 2)

Â  Â  Â  Â  Â  Â  Â  Â  })

Â  Â  Â  Â 

Â  Â  Â  Â  self.data['total_pl'] = total_pl

Â  Â  Â  Â  self.data['pl_results'] = pd.DataFrame(results)

Â  Â  Â  Â  print(f"âœ… P/L totale del portafoglio calcolato: {total_pl:,.2f}")

Â  Â  Â  Â  print("\nDettaglio P/L:")

Â  Â  Â  Â  print(self.data['pl_results'].to_string(index=False))



Â  Â  def step_4_generate_ytd_charts(self):

Â  Â  Â  Â  """BLOCCO 4: Generazione grafici di performance YTD."""

Â  Â  Â  Â  print("Fase 4: Generazione grafici YTD...")

Â  Â  Â  Â  for ticker, info in self.portfolio.items():

Â  Â  Â  Â  Â  Â  if ticker in self.data and 'history' in self.data[ticker] and not self.data[ticker]['history'].empty:

Â  Â  Â  Â  Â  Â  Â  Â  print(f"Generando grafico YTD per {ticker}...")

Â  Â  Â  Â  Â  Â  Â  Â  plot_price_performance(ticker, self.data[ticker]['history'])

Â  Â  Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  Â  Â  print(f"âŒ Dati storici non disponibili per {ticker}. Saltando il grafico.")



Â  Â  def step_5_macro_analysis(self):

Â  Â  Â  Â  """BLOCCO 5: Esegue un'analisi macroeconomica."""

Â  Â  Â  Â  print("Fase 5: Analisi macro...")

Â  Â  Â  Â  cpi_data = get_cpi_data()

Â  Â  Â  Â 

Â  Â  Â  Â  # Aggiungo una logica per l'analisi macro come hai suggerito

Â  Â  Â  Â  if not cpi_data.empty:

Â  Â  Â  Â  Â  Â  self.data['cpi_data'] = cpi_data

Â  Â  Â  Â  Â  Â  # Aggiungi qui la tua logica di analisi basata sui dati

Â  Â  Â  Â  Â  Â  # Esempio: calcola la variazione trimestrale e genera un segnale

Â  Â  Â  Â  Â  Â  last_cpi_value = cpi_data.iloc[-1]

Â  Â  Â  Â  Â  Â  cpi_change = (last_cpi_value - cpi_data.iloc[-2]) / cpi_data.iloc[-2] * 100

Â  Â  Â  Â  Â  Â 

Â  Â  Â  Â  Â  Â  if cpi_change > 0.5:

Â  Â  Â  Â  Â  Â  Â  Â  self.data['macro_signal'] = 'inflazione_in_aumento'

Â  Â  Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  Â  Â  self.data['macro_signal'] = 'inflazione_stabile'



Â  Â  Â  Â  Â  Â  print(f"âœ… Dati CPI pronti per l'analisi. Segnale: {self.data['macro_signal']}.")

Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  print("âŒ Impossibile recuperare dati CPI. Saltando l'analisi macro.")

Â  Â  Â  Â  Â  Â  self.data['macro_signal'] = 'errore'

Â  Â 

Â  Â  def step_6_stock_screener(self):

Â  Â  Â  Â  """

Â  Â  Â  Â  BLOCCO 6: Esegue uno screening di titoli in base a segnali macro e criteri

Â  Â  Â  Â  di bilancio. Questo Ã¨ il "sub-agente" che trova i candidati.

Â  Â  Â  Â  """

Â  Â  Â  Â  print("Fase 6: Screening e Selezione di nuovi titoli...")

Â  Â  Â  Â 

Â  Â  Â  Â  # Logica di esempio basata sul segnale macro

Â  Â  Â  Â  if self.data.get('macro_signal') == 'inflazione_in_aumento':

Â  Â  Â  Â  Â  Â  print("Scenario: Inflazione in aumento. Cerco titoli difensivi e a dividendo.")

Â  Â  Â  Â  Â  Â  # Qui si integrerÃ  la logica per cercare i titoli e gli ETF adatti

Â  Â  Â  Â  Â  Â  # Usando dati da Finnhub per bilanci e dividendi

Â  Â  Â  Â  elif self.data.get('macro_signal') == 'inflazione_stabile':

Â  Â  Â  Â  Â  Â  print("Scenario: Inflazione stabile. Cerco titoli growth o a bassa volatilitÃ .")

Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  print("Nessun segnale macro affidabile. Lo screener si basa su criteri generali.")



Â  Â  Â  Â  # Qui avverrÃ  la chiamata alle API di Finnhub e la logica di filtro.

Â  Â  Â  Â  # Per ora, Ã¨ un placeholder.

Â  Â  Â  Â  print("â³ Il motore di screening Ã¨ in fase di sviluppo...")



Â  Â  def step_7_generate_final_report(self):

Â  Â  Â  Â  """BLOCCO 7: Crea un report finale leggibile."""

Â  Â  Â  Â  print("Fase 7: Generazione del report...")

Â  Â  Â  Â  print("\n" + "="*80)

Â  Â  Â  Â  print("ğŸ“‘ RISULTATI ANALISI PORTAFOGLIO (aggiornati in tempo reale)")

Â  Â  Â  Â  print(f"ğŸ’° Valore totale portafoglio: {self.data.get('total_value', 0):,.2f}")

Â  Â  Â  Â  print(f"ğŸ“ˆ P/L totale non realizzato: {self.data.get('total_pl', 0):,.2f}")

Â  Â  Â  Â  print("="*80)

Â  Â  Â  Â 

Â  Â  Â  Â  if 'pl_results' in self.data and not self.data['pl_results'].empty:

Â  Â  Â  Â  Â  Â  print("\nğŸ“ˆ Composizione Portafoglio:")

Â  Â  Â  Â  Â  Â  print(self.data['pl_results'].to_string(index=False))

Â  Â  Â  Â  Â  Â 

Â  Â  Â  Â  Â  Â  top_3 = self.data['pl_results'].sort_values('Rendimento', ascending=False).head(3)

Â  Â  Â  Â  Â  Â  flop_3 = self.data['pl_results'].sort_values('Rendimento').head(3)

Â  Â  Â  Â  Â  Â 

Â  Â  Â  Â  Â  Â  print("\nğŸ† Top 3 titoli:")

Â  Â  Â  Â  Â  Â  print(top_3.to_string(index=False))

Â  Â  Â  Â  Â  Â 

Â  Â  Â  Â  Â  Â  print("\nğŸ“‰ Flop 3 titoli:")

Â  Â  Â  Â  Â  Â  print(flop_3.to_string(index=False))

Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  print("\nâŒ Impossibile generare l'analisi del portafoglio a causa di dati mancanti.")

Â  Â 

Â  Â  def step_8_portfolio_check(self):

Â  Â  Â  Â  """

Â  Â  Â  Â  BLOCCO 8: Questo Ã¨ il sub-agente che controlla i titoli esistenti nel portafoglio.

Â  Â  Â  Â  Controlla bilancio, sentiment e valore intrinseco.

Â  Â  Â  Â  """

Â  Â  Â  Â  print("\nFase 8: Controllo dei titoli esistenti nel portafoglio...")

Â  Â  Â  Â 

Â  Â  Â  Â  for ticker in self.portfolio.keys():

Â  Â  Â  Â  Â  Â  print(f"Analisi di bilancio e sentiment per {ticker}...")

Â  Â  Â  Â  Â  Â  # Qui si integrerÃ  la logica per controllare i bilanci (Finnhub) e

Â  Â  Â  Â  Â  Â  # fare un'analisi piÃ¹ approfondita, come hai suggerito tu.

Â  Â  Â  Â  Â  Â  # Per ora, Ã¨ un placeholder.

Â  Â  Â  Â  Â  Â 

Â  Â  Â  Â  print("âœ… Controllo del portafoglio completato.")



Â  Â  def step_9_export_to_json(self):

Â  Â  Â  Â  """

Â  Â  Â  Â  BLOCCO 9: Esporta i dati analizzati in un file JSON.

Â  Â  Â  Â  Questo file farÃ  da ponte tra l'agente Python e l'interfaccia web.

Â  Â  Â  Â  """

Â  Â  Â  Â  print("\nFase 9: Esportazione dei dati in formato JSON...")

Â  Â  Â  Â 

Â  Â  Â  Â  # Prepara un dizionario per l'esportazione

Â  Â  Â  Â  export_data = {

Â  Â  Â  Â  Â  Â  'last_update': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),

Â  Â  Â  Â  Â  Â  'total_value': self.data.get('total_value'),

Â  Â  Â  Â  Â  Â  'total_pl': self.data.get('total_pl'),

Â  Â  Â  Â  Â  Â  'portfolio_details': []

Â  Â  Â  Â  }

Â  Â  Â  Â 

Â  Â  Â  Â  # Aggiungi i dettagli del portafoglio, convertendo il DataFrame in una lista di dizionari

Â  Â  Â  Â  if 'pl_results' in self.data and not self.data['pl_results'].empty:

Â  Â  Â  Â  Â  Â  export_data['portfolio_details'] = self.data['pl_results'].to_dict('records')

Â  Â  Â  Â 

Â  Â  Â  Â  # Salva il dizionario su un file JSON

Â  Â  Â  Â  try:

Â  Â  Â  Â  Â  Â  with open('portfolio_data.json', 'w') as f:

Â  Â  Â  Â  Â  Â  Â  Â  json.dump(export_data, f, indent=4)

Â  Â  Â  Â  Â  Â  print("âœ… Dati del portafoglio esportati con successo in 'portfolio_data.json'.")

Â  Â  Â  Â  except Exception as e:

Â  Â  Â  Â  Â  Â  print(f"âŒ Errore durante l'esportazione in JSON: {e}")



if __name__ == "__main__":

Â  Â  strategist = ChiefInvestmentStrategist(PORTFOLIO)

Â  Â  strategist.execute_strategy()